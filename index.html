<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Excel Randomizer Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; transition: background 0.3s ease; }
        button { touch-action: manipulation; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .sheet-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #eee; font-size: 16px; }
        @media (max-width: 600px) {
            .cell-display { font-size: 20px !important; padding: 15px !important; }
            .setup-card { width: 90% !important; max-width: 350px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const lightTheme = { bg: '#f8f9fa', card: '#fff', text: '#212529', border: '#ddd', primary: '#007bff', navBtn: '#444' };
        const darkTheme = { bg: '#121212', card: '#1e1e1e', text: '#f8f9fa', border: '#333', primary: '#007bff', navBtn: '#555' };

        function App() {
            const [workbook, setWorkbook] = useState(null);
            const [sheetNames, setSheetNames] = useState([]);
            const [selectedSheets, setSelectedSheets] = useState([]);
            const [currentRow, setCurrentRow] = useState(null);
            const [colIndex, setColIndex] = useState(0);
            const [rowIndex, setRowIndex] = useState(0);
            const [darkMode, setDarkMode] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [isPaused, setIsPaused] = useState(false);

            const theme = darkMode ? darkTheme : lightTheme;

            // Voice Loading Logic for iPhone
            const getDanielVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                // Priority 1: Daniel (Enhanced) | Priority 2: Daniel | Priority 3: any en-GB
                return voices.find(v => v.name.includes("Daniel") && v.name.includes("Enhanced")) ||
                       voices.find(v => v.name.includes("Daniel")) ||
                       voices.find(v => v.lang === "en-GB" || v.lang === "en_GB");
            };

            const handleToggleSpeech = () => {
                if (isSpeaking && !isPaused) {
                    window.speechSynthesis.pause();
                    setIsPaused(true);
                } else if (isPaused) {
                    window.speechSynthesis.resume();
                    setIsPaused(false);
                } else {
                    window.speechSynthesis.cancel();
                    const text = currentRow.data[colIndex];
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    const voice = getDanielVoice();
                    if (voice) {
                        utterance.voice = voice;
                        utterance.lang = 'en-GB';
                    }

                    utterance.rate = 0.9;
                    utterance.onstart = () => { setIsSpeaking(true); setIsPaused(false); };
                    utterance.onend = () => { setIsSpeaking(false); setIsPaused(false); };
                    utterance.onerror = () => { setIsSpeaking(false); setIsPaused(false); };
                    
                    window.speechSynthesis.speak(utterance);
                }
            };

            const handleStopSpeech = () => {
                window.speechSynthesis.cancel();
                setIsSpeaking(false);
                setIsPaused(false);
            };

            const updateActiveCell = (sheetName, rIdx, cIdx) => {
                handleStopSpeech();
                const sheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                setCurrentRow({ data: data[rIdx], sheet: sheetName });
                setColIndex(cIdx);
                setRowIndex(rIdx);
                setSearchResults([]);
            };

            const pickRandom = () => {
                if (selectedSheets.length === 0) return alert("Please select a sheet!");
                let pool = [];
                selectedSheets.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                    data.forEach((row, rIdx) => { if (row[0] && String(row[0]).trim()) pool.push({ sheet: name, rIdx }); });
                });
                if (pool.length === 0) return alert("No data found.");
                const pick = pool[Math.floor(Math.random() * pool.length)];
                updateActiveCell(pick.sheet, pick.rIdx, 0);
            };

            const handleSearch = () => {
                if (!searchQuery.trim()) return;
                let results = [];
                selectedSheets.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                    data.forEach((row, rIdx) => {
                        row.forEach((cell, cIdx) => {
                            if (String(cell).toLowerCase().includes(searchQuery.toLowerCase())) {
                                results.push({ sheet: name, rIdx, cIdx, text: String(cell) });
                            }
                        });
                    });
                });
                setSearchResults(results);
            };

            const hasContent = (rOffset, cOffset) => {
                if(!workbook || !currentRow) return false;
                const sheet = workbook.Sheets[currentRow.sheet];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                const val = data[rowIndex + rOffset]?.[colIndex + cOffset];
                return val !== undefined && val !== null && String(val).trim().length > 0;
            };

            return (
                <div style={{ height: '100vh', width: '100vw', backgroundColor: theme.bg, color: theme.text, display: 'flex', flexDirection: 'column' }}>
                    {!currentRow ? (
                        <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100%', overflowY: 'auto' }}>
                            <div className="setup-card" style={{ padding: '25px', background: theme.card, borderRadius: '15px', width: '340px', boxShadow: '0 10px 30px rgba(0,0,0,0.3)' }}>
                                <h2 style={{ textAlign: 'center', marginBottom: '20px' }}>Excel Randomizer</h2>
                                <div style={{ marginBottom: '15px', display: 'flex', justifyContent: 'space-between' }}>
                                    <label><input type="checkbox" checked={darkMode} onChange={() => setDarkMode(!darkMode)} /> Night Mode</label>
                                    <input type="file" onChange={(e) => {
                                        const reader = new FileReader();
                                        reader.onload = (evt) => {
                                            const wb = XLSX.read(evt.target.result, { type: 'binary' });
                                            setWorkbook(wb); setSheetNames(wb.SheetNames); setSelectedSheets([]);
                                        };
                                        reader.readAsBinaryString(e.target.files[0]);
                                    }} style={{ width: '150px' }} />
                                </div>
                                {sheetNames.length > 0 && (
                                    <div style={{ marginBottom: '20px' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                            <b>Sheets:</b>
                                            <button onClick={() => setSelectedSheets(selectedSheets.length === sheetNames.length ? [] : [...sheetNames])} style={{ fontSize: '12px', padding: '2px 8px', background: '#666', color: '#fff' }}>Toggle All</button>
                                        </div>
                                        <div className="sidebar-scroll" style={{ maxHeight: '350px', overflowY: 'auto', border: `1px solid ${theme.border}`, borderRadius: '8px' }}>
                                            {sheetNames.map(name => (
                                                <label key={name} className="sheet-item">
                                                    <input type="checkbox" checked={selectedSheets.includes(name)} onChange={() => setSelectedSheets(prev => prev.includes(name) ? prev.filter(s => s !== name) : [...prev, name])} />
                                                    {name}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <button onClick={pickRandom} style={{ width: '100%', padding: '15px', background: '#28a745', color: '#fff', fontSize: '18px', fontWeight: 'bold' }}>START</button>
                            </div>
                        </div>
                    ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                            <div style={{ display: 'flex', padding: '10px', borderBottom: `1px solid ${theme.border}`, justifyContent: 'space-between', alignItems: 'center', background: theme.card }}>
                                <span style={{ fontSize: '12px' }}>{currentRow.sheet} | {String.fromCharCode(65 + colIndex)}{rowIndex + 1}</span>
                                <div style={{ display: 'flex', gap: '5px' }}>
                                    <input placeholder="Find..." style={{ width: '80px', padding: '5px', borderRadius: '5px', border: `1px solid ${theme.border}`, background: theme.bg, color: theme.text }} value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSearch()} />
                                    <button onClick={handleSearch} style={{ padding: '5px 10px', background: theme.primary, color: '#fff' }}>üîç</button>
                                </div>
                            </div>
                            <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
                                {searchResults.length > 0 && (
                                    <div className="sidebar-scroll" style={{ width: '150px', background: theme.card, borderRight: `1px solid ${theme.border}`, overflowY: 'auto', padding: '10px', fontSize: '11px' }}>
                                        <button onClick={() => setSearchResults([])} style={{ color: 'red', marginBottom: '10px' }}>Close Results</button>
                                        {searchResults.map((r, i) => (
                                            <div key={i} onClick={() => updateActiveCell(r.sheet, r.rIdx, r.cIdx)} style={{ padding: '8px 0', borderBottom: `1px solid ${theme.border}`, cursor: 'pointer' }}>
                                                {String.fromCharCode(65 + r.cIdx)}{r.rIdx+1}: {r.text.substring(0,20)}...
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="cell-display" style={{ flex: 1, padding: '30px', fontSize: '24px', overflowY: 'auto', whiteSpace: 'pre-wrap' }}>{currentRow.data[colIndex]}</div>
                            </div>
                            <div style={{ padding: '20px', background: theme.card, borderTop: `1px solid ${theme.border}`, display: 'flex', flexDirection: 'column', gap: '15px', alignItems: 'center' }}>
                                <div style={{ display: 'flex', gap: '10px', width: '100%' }}>
                                    <button onClick={handleToggleSpeech} style={{ flex: 2, padding: '15px', background: isPaused ? '#ffc107' : (isSpeaking ? '#fd7e14' : '#28a745'), color: '#fff', fontWeight: 'bold' }}>
                                        {isPaused ? '‚ñ∂Ô∏è RESUME' : (isSpeaking ? '‚è∏Ô∏è PAUSE' : 'üîä READ (UK)')}
                                    </button>
                                    {(isSpeaking || isPaused) && <button onClick={handleStopSpeech} style={{ flex: 0.5, background: '#dc3545', color: '#fff' }}>‚èπÔ∏è</button>}
                                    <button onClick={pickRandom} style={{ flex: 1.5, background: theme.primary, color: '#fff', fontWeight: 'bold' }}>NEXT</button>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px' }}>
                                    {hasContent(-1, 0) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex - 1, colIndex)} style={{ padding: '10px 30px', background: theme.navBtn, color: '#fff' }}>‚Üë</button>}
                                    <div style={{ display: 'flex', gap: '10px' }}>
                                        {hasContent(0, -1) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex, colIndex - 1)} style={{ padding: '10px 30px', background: theme.navBtn, color: '#fff' }}>‚Üê</button>}
                                        {hasContent(1, 0) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex + 1, colIndex)} style={{ padding: '10px 30px', background: theme.navBtn, color: '#fff' }}>‚Üì</button>}
                                        {hasContent(0, 1) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex, colIndex + 1)} style={{ padding: '10px 30px', background: theme.navBtn, color: '#fff' }}>‚Üí</button>}
                                    </div>
                                </div>
                            </div>
                            <div style={{ position: 'fixed', bottom: '15px', right: '15px', display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                <button onClick={() => setDarkMode(!darkMode)} style={{ padding: '12px', background: theme.navBtn, color: '#fff', borderRadius: '50%' }}>{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                                <button onClick={() => {handleStopSpeech(); setCurrentRow(null);}} style={{ padding: '12px', background: '#666', color: '#fff', borderRadius: '50%' }}>‚öôÔ∏è</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
