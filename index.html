<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Excel Randomizer Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; transition: background 0.3s ease; }
        button { touch-action: manipulation; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .sheet-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; }
        @media (max-width: 600px) {
            .cell-display { font-size: 20px !important; padding: 15px !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const lightTheme = { bg: '#f8f9fa', card: '#fff', text: '#212529', border: '#ddd', primary: '#007bff', navBtn: '#444' };
        const darkTheme = { bg: '#121212', card: '#1e1e1e', text: '#f8f9fa', border: '#333', primary: '#007bff', navBtn: '#555' };

        function App() {
            const [workbook, setWorkbook] = useState(null);
            const [sheetNames, setSheetNames] = useState([]);
            const [selectedSheets, setSelectedSheets] = useState([]);
            const [currentRow, setCurrentRow] = useState(null);
            const [colIndex, setColIndex] = useState(0);
            const [rowIndex, setRowIndex] = useState(0);
            const [darkMode, setDarkMode] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const [availableVoices, setAvailableVoices] = useState([]);

            const theme = darkMode ? darkTheme : lightTheme;

            useEffect(() => {
                const loadVoices = () => {
                    const voices = window.speechSynthesis.getVoices();
                    setAvailableVoices(voices);
                };
                loadVoices();
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
            }, []);

            const getColLetter = (index) => String.fromCharCode(65 + index);
            const hasContent = (val) => val !== undefined && val !== null && String(val).trim().length > 0;

            const getNeighborData = (rOffset, cOffset) => {
                if(!workbook || !currentRow) return null;
                const sheet = workbook.Sheets[currentRow.sheet];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                return data[rowIndex + rOffset]?.[colIndex + cOffset];
            };

            const updateActiveCell = (sheetName, rIdx, cIdx) => {
                handleStopSpeech();
                const sheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                setCurrentRow({ data: data[rIdx], sheet: sheetName });
                setColIndex(cIdx);
                setRowIndex(rIdx);
                setSearchResults([]);
            };

            const pickRandom = () => {
                if (selectedSheets.length === 0) return alert("Please select at least one sheet.");
                let pool = [];
                selectedSheets.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                    data.forEach((row, rIdx) => { if (hasContent(row[0])) pool.push({ sheet: name, rIdx }); });
                });
                if (pool.length === 0) return alert("No content found.");
                const pick = pool[Math.floor(Math.random() * pool.length)];
                updateActiveCell(pick.sheet, pick.rIdx, 0);
            };

            const handleSearch = () => {
                if (!searchQuery.trim()) return;
                let results = [];
                selectedSheets.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                    data.forEach((row, rIdx) => {
                        row.forEach((cell, cIdx) => {
                            if (String(cell).toLowerCase().includes(searchQuery.toLowerCase())) {
                                results.push({ sheet: name, rIdx, cIdx, text: String(cell) });
                            }
                        });
                    });
                });
                setSearchResults(results);
            };

            // Enhanced Native Voice Selection
            const handleToggleSpeech = () => {
                if (isSpeaking && !isPaused) {
                    window.speechSynthesis.pause();
                    setIsPaused(true);
                } else if (isPaused) {
                    window.speechSynthesis.resume();
                    setIsPaused(false);
                } else {
                    window.speechSynthesis.cancel();
                    const text = currentRow.data[colIndex];
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // Specific priority for Native Daniel (UK)
                    const nativeVoice = availableVoices.find(v => 
                        (v.name.includes("Daniel") && v.lang === "en-GB") || 
                        (v.lang === "en-GB" && v.name.includes("Enhanced")) ||
                        (v.lang === "en-GB")
                    );
                    
                    if (nativeVoice) {
                        utterance.voice = nativeVoice;
                    }
                    
                    utterance.rate = 0.9; // Slightly slower for natural clarity
                    utterance.onend = () => { setIsSpeaking(false); setIsPaused(false); };
                    window.speechSynthesis.speak(utterance);
                    setIsSpeaking(true);
                    setIsPaused(false);
                }
            };

            const handleStopSpeech = () => {
                window.speechSynthesis.cancel();
                setIsSpeaking(false);
                setIsPaused(false);
            };

            return (
                <div style={{ height: '100vh', width: '100vw', backgroundColor: theme.bg, color: theme.text, display: 'flex', flexDirection: 'column' }}>
                    
                    {!currentRow ? (
                        <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100%' }}>
                            <div style={{ padding: '25px', background: theme.card, borderRadius: '15px', width: '320px', textAlign: 'center', boxShadow: '0 10px 30px rgba(0,0,0,0.3)' }}>
                                <h2 style={{ margin: '0 0 15px 0' }}>Excel Randomizer</h2>
                                <div style={{ marginBottom: '15px', textAlign: 'left', fontSize: '14px' }}>
                                    <label style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <input type="checkbox" checked={darkMode} onChange={() => setDarkMode(!darkMode)} /> 
                                        <span>Night Mode</span>
                                    </label>
                                </div>
                                
                                <input type="file" onChange={(e) => {
                                    const reader = new FileReader();
                                    reader.onload = (evt) => {
                                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                                        setWorkbook(wb); setSheetNames(wb.SheetNames); setSelectedSheets(wb.SheetNames);
                                    };
                                    reader.readAsBinaryString(e.target.files[0]);
                                }} style={{ width: '100%', marginBottom: '15px', color: theme.text }} />

                                {sheetNames.length > 0 && (
                                    <div style={{ marginBottom: '15px' }}>
                                        <div className="sidebar-scroll" style={{ maxHeight: '120px', overflowY: 'auto', textAlign: 'left', border: `1px solid ${theme.border}`, borderRadius: '8px' }}>
                                            {sheetNames.map(name => (
                                                <label key={name} className="sheet-item">
                                                    <input type="checkbox" checked={selectedSheets.includes(name)} onChange={() => setSelectedSheets(prev => prev.includes(name) ? prev.filter(s => s !== name) : [...prev, name])} />
                                                    <span>{name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <button onClick={pickRandom} style={{ width: '100%', padding: '14px', background: theme.primary, color: '#fff', fontWeight: 'bold' }}>START</button>
                            </div>
                        </div>
                    ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                            {/* Navbar */}
                            <div style={{ display: 'flex', padding: '10px 15px', borderBottom: `1px solid ${theme.border}`, justifyContent: 'space-between', alignItems: 'center', background: theme.card }}>
                                <span style={{ fontWeight: 'bold', fontSize: '11px' }}>{currentRow.sheet} | {getColLetter(colIndex)}{rowIndex + 1}</span>
                                <div style={{ display: 'flex', gap: '5px' }}>
                                    <input placeholder="Find..." style={{ padding: '8px', borderRadius: '5px', border: `1px solid ${theme.border}`, background: theme.bg, color: theme.text, width: '70px' }} value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSearch()} />
                                    <button onClick={handleSearch} style={{ padding: '8px 12px', background: theme.primary, color: '#fff' }}>üîç</button>
                                </div>
                            </div>

                            <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
                                {searchResults.length > 0 && (
                                    <div className="sidebar-scroll" style={{ width: '150px', background: theme.card, borderRight: `1px solid ${theme.border}`, overflowY: 'auto', padding: '10px' }}>
                                        {searchResults.map((r, i) => (
                                            <div key={i} onClick={() => updateActiveCell(r.sheet, r.rIdx, r.cIdx)} style={{ padding: '5px', borderBottom: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '10px' }}>
                                                {getColLetter(r.cIdx)}{r.rIdx+1}: {r.text.substring(0,15)}...
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="cell-display" style={{ flex: 1, padding: '25px', fontSize: '24px', overflowY: 'auto', color: theme.text, whiteSpace: 'pre-wrap' }}>
                                    {currentRow.data[colIndex]}
                                </div>
                            </div>

                            <div style={{ padding: '15px', display: 'flex', flexDirection: 'column', alignItems: 'center', background: theme.card, borderTop: `1px solid ${theme.border}`, gap: '10px' }}>
                                <div style={{ display: 'flex', gap: '8px', width: '100%', justifyContent: 'center' }}>
                                    <button onClick={handleToggleSpeech} style={{ flex: 1, padding: '12px', background: isPaused ? '#ffc107' : (isSpeaking ? '#fd7e14' : '#28a745'), color: '#fff', fontWeight: 'bold' }}>
                                        {isPaused ? '‚ñ∂Ô∏è RESUME' : (isSpeaking ? '‚è∏Ô∏è PAUSE' : 'üîä READ (UK)')}
                                    </button>
                                    {(isSpeaking || isPaused) && (
                                        <button onClick={handleStopSpeech} style={{ padding: '12px 20px', background: '#dc3545', color: '#fff' }}>‚èπÔ∏è</button>
                                    )}
                                    <button onClick={pickRandom} style={{ flex: 1, padding: '12px', background: theme.primary, color: '#fff', fontWeight: 'bold' }}>NEXT</button>
                                </div>
                                
                                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '5px' }}>
                                    {hasContent(getNeighborData(-1, 0)) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex - 1, colIndex)} style={{ padding: '8px 25px', background: theme.navBtn, color: '#fff' }}>‚Üë</button>}
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        {hasContent(getNeighborData(0, -1)) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex, colIndex - 1)} style={{ padding: '8px 25px', background: theme.navBtn, color: '#fff' }}>‚Üê</button>}
                                        {hasContent(getNeighborData(1, 0)) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex + 1, colIndex)} style={{ padding: '8px 25px', background: theme.navBtn, color: '#fff' }}>‚Üì</button>}
                                        {hasContent(getNeighborData(0, 1)) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex, colIndex + 1)} style={{ padding: '8px 25px', background: theme.navBtn, color: '#fff' }}>‚Üí</button>}
                                    </div>
                                </div>
                            </div>
                            
                            <div style={{ position: 'fixed', bottom: '15px', right: '15px', display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                <button onClick={() => setDarkMode(!darkMode)} style={{ padding: '10px', background: theme.navBtn, color: '#fff', borderRadius: '50%' }}>{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                                <button onClick={() => {handleStopSpeech(); setCurrentRow(null);}} style={{ padding: '10px', background: '#666', color: '#fff', borderRadius: '50%' }}>‚öôÔ∏è</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
