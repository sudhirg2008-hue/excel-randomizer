<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Excel Randomizer Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; transition: background 0.3s ease; }
        button { touch-action: manipulation; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .sheet-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #eee; font-size: 16px; }
        .side-panel { position: absolute; top: 50px; bottom: 0; width: 220px; z-index: 10; transition: transform 0.3s ease; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        @media (max-width: 600px) {
            .cell-display { font-size: 22px !important; padding: 20px !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const lightTheme = { bg: '#f8f9fa', card: '#fff', text: '#212529', border: '#ddd', primary: '#007bff', navBtn: '#444', panel: '#eee' };
        const darkTheme = { bg: '#121212', card: '#1e1e1e', text: '#f8f9fa', border: '#333', primary: '#007bff', navBtn: '#555', panel: '#252525' };

        function App() {
            const [workbook, setWorkbook] = useState(null);
            const [sheetNames, setSheetNames] = useState([]);
            const [selectedSheets, setSelectedSheets] = useState([]);
            const [currentRow, setCurrentRow] = useState(null);
            const [colIndex, setColIndex] = useState(0);
            const [rowIndex, setRowIndex] = useState(0);
            const [darkMode, setDarkMode] = useState(false);
            
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [history, setHistory] = useState([]);
            
            const [showSearch, setShowSearch] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [isPaused, setIsPaused] = useState(false);

            const theme = darkMode ? darkTheme : lightTheme;

            const getBestVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                return voices.find(v => v.name.toLowerCase().includes("alex")) || 
                       voices.find(v => v.name.toLowerCase().includes("daniel")) || 
                       voices.find(v => v.lang.startsWith("en"));
            };

            const handleToggleSpeech = () => {
                if (isSpeaking && !isPaused) { window.speechSynthesis.pause(); setIsPaused(true); }
                else if (isPaused) { window.speechSynthesis.resume(); setIsPaused(false); }
                else {
                    window.speechSynthesis.cancel();
                    const text = currentRow.data[colIndex];
                    if(!text) return;
                    const utterance = new SpeechSynthesisUtterance(text);
                    const voice = getBestVoice();
                    if (voice) utterance.voice = voice;
                    utterance.onstart = () => { setIsSpeaking(true); setIsPaused(false); };
                    utterance.onend = () => { setIsSpeaking(false); setIsPaused(false); };
                    window.speechSynthesis.speak(utterance);
                }
            };

            const updateActiveCell = (sheetName, rIdx, cIdx, skipHistory = false) => {
                window.speechSynthesis.cancel();
                setIsSpeaking(false);
                setIsPaused(false);
                const sheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                const cellText = data[rIdx][cIdx];
                
                if(!skipHistory) {
                    setHistory(prev => [{ sheet: sheetName, rIdx, cIdx, text: cellText }, ...prev].slice(0, 50));
                }
                
                setCurrentRow({ data: data[rIdx], sheet: sheetName });
                setColIndex(cIdx);
                setRowIndex(rIdx);
            };

            const pickRandom = () => {
                if (selectedSheets.length === 0) return alert("Select a sheet!");
                let pool = [];
                selectedSheets.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                    data.forEach((row, rIdx) => { if (row[0] && String(row[0]).trim()) pool.push({ sheet: name, rIdx }); });
                });
                const pick = pool[Math.floor(Math.random() * pool.length)];
                updateActiveCell(pick.sheet, pick.rIdx, 0);
            };

            const handleSearch = () => {
                if (!searchQuery.trim()) return;
                let results = [];
                selectedSheets.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                    data.forEach((row, rIdx) => {
                        row.forEach((cell, cIdx) => {
                            if (String(cell).toLowerCase().includes(searchQuery.toLowerCase())) {
                                results.push({ sheet: name, rIdx, cIdx, text: String(cell) });
                            }
                        });
                    });
                });
                setSearchResults(results);
            };

            const hasContent = (rOff, cOff) => {
                if(!workbook || !currentRow) return false;
                const sheet = workbook.Sheets[currentRow.sheet];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                const val = data[rowIndex + rOff]?.[colIndex + cOff];
                return val !== undefined && val !== null && String(val).trim().length > 0;
            };

            return (
                <div style={{ height: '100vh', width: '100vw', backgroundColor: theme.bg, color: theme.text, display: 'flex', flexDirection: 'column', position: 'relative' }}>
                    {!currentRow ? (
                        <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100%' }}>
                            <div style={{ padding: '25px', background: theme.card, borderRadius: '15px', width: '340px', boxShadow: '0 10px 30px rgba(0,0,0,0.3)' }}>
                                <h2 style={{ textAlign: 'center' }}>Excel Randomizer</h2>
                                <input type="file" onChange={(e) => {
                                    const reader = new FileReader();
                                    reader.onload = (evt) => {
                                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                                        setWorkbook(wb); setSheetNames(wb.SheetNames); setSelectedSheets([]);
                                    };
                                    reader.readAsBinaryString(e.target.files[0]);
                                }} style={{ marginBottom: '15px', width: '100%' }} />
                                {sheetNames.length > 0 && (
                                    <div className="sidebar-scroll" style={{ maxHeight: '300px', overflowY: 'auto', border: `1px solid ${theme.border}`, marginBottom: '15px' }}>
                                        {sheetNames.map(name => (
                                            <label key={name} className="sheet-item">
                                                <input type="checkbox" checked={selectedSheets.includes(name)} onChange={() => setSelectedSheets(prev => prev.includes(name) ? prev.filter(s => s !== name) : [...prev, name])} />
                                                {name}
                                            </label>
                                        ))}
                                    </div>
                                )}
                                <button onClick={pickRandom} style={{ width: '100%', padding: '15px', background: '#28a745', color: '#fff', fontWeight: 'bold' }}>START</button>
                            </div>
                        </div>
                    ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                            {/* Navbar */}
                            <div style={{ height: '50px', display: 'flex', padding: '0 15px', borderBottom: `1px solid ${theme.border}`, justifyContent: 'space-between', alignItems: 'center', background: theme.card }}>
                                <div style={{ display: 'flex', gap: '15px' }}>
                                    <button onClick={() => {setShowSearch(!showSearch); setShowHistory(false);}} style={{ background: 'none', fontSize: '20px' }}>üîç</button>
                                    <button onClick={() => {setShowHistory(!showHistory); setShowSearch(false);}} style={{ background: 'none', fontSize: '20px' }}>üìú</button>
                                </div>
                                <span style={{ fontSize: '12px', fontWeight: 'bold' }}>{String.fromCharCode(65 + colIndex)}{rowIndex + 1}</span>
                                <button onClick={() => setCurrentRow(null)} style={{ padding: '5px 10px', background: '#666', color: '#fff', fontSize: '11px' }}>EXIT</button>
                            </div>

                            {/* Search Panel */}
                            <div className="side-panel sidebar-scroll" style={{ left: 0, transform: showSearch ? 'translateX(0)' : 'translateX(-100%)', background: theme.panel, borderRight: `1px solid ${theme.border}` }}>
                                <input placeholder="Search text..." style={{ width: '100%', padding: '8px', marginBottom: '10px' }} value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSearch()} />
                                {searchResults.map((r, i) => (
                                    <div key={i} onClick={() => {updateActiveCell(r.sheet, r.rIdx, r.cIdx); setShowSearch(false);}} style={{ padding: '8px', borderBottom: '1px solid #ccc', fontSize: '12px', cursor: 'pointer' }}>
                                        <b>{r.sheet}</b>: {r.text}
                                    </div>
                                ))}
                            </div>

                            {/* History Panel */}
                            <div className="side-panel sidebar-scroll" style={{ right: 0, transform: showHistory ? 'translateX(0)' : 'translateX(100%)', background: theme.panel, borderLeft: `1px solid ${theme.border}` }}>
                                <h3>History</h3>
                                {history.map((h, i) => (
                                    <div key={i} onClick={() => {updateActiveCell(h.sheet, h.rIdx, h.cIdx, true); setShowHistory(false);}} style={{ padding: '8px', borderBottom: '1px solid #ccc', fontSize: '12px', cursor: 'pointer' }}>
                                        {h.text.substring(0, 30)}...
                                    </div>
                                ))}
                            </div>

                            {/* Main Content */}
                            <div style={{ flex: 1, padding: '20px', fontSize: '24px', overflowY: 'auto', display: 'flex', alignItems: 'center', justifyContent: 'center', textAlign: 'center' }}>
                                {currentRow.data[colIndex]}
                            </div>

                            {/* Bottom Controls */}
                            <div style={{ padding: '15px', background: theme.card, borderTop: `1px solid ${theme.border}`, display: 'flex', flexDirection: 'column', gap: '10px', alignItems: 'center' }}>
                                <div style={{ display: 'flex', gap: '10px', width: '100%' }}>
                                    <button onClick={handleToggleSpeech} style={{ flex: 2, padding: '15px', background: isPaused ? '#ffc107' : (isSpeaking ? '#fd7e14' : '#28a745'), color: '#fff', fontSize: '18px' }}>
                                        {isPaused ? '‚ñ∂Ô∏è' : (isSpeaking ? '‚è∏Ô∏è' : 'üîä')}
                                    </button>
                                    <button onClick={pickRandom} style={{ flex: 1.5, background: theme.primary, color: '#fff', fontWeight: 'bold' }}>NEXT</button>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px' }}>
                                    <div />
                                    {hasContent(-1, 0) ? <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex - 1, colIndex)} style={{ padding: '10px 25px', background: theme.navBtn, color: '#fff' }}>‚Üë</button> : <div />}
                                    <div />
                                    {hasContent(0, -1) ? <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex, colIndex - 1)} style={{ padding: '10px 25px', background: theme.navBtn, color: '#fff' }}>‚Üê</button> : <div />}
                                    {hasContent(1, 0) ? <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex + 1, colIndex)} style={{ padding: '10px 25px', background: theme.navBtn, color: '#fff' }}>‚Üì</button> : <div />}
                                    {hasContent(0, 1) ? <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex, colIndex + 1)} style={{ padding: '10px 25px', background: theme.navBtn, color: '#fff' }}>‚Üí</button> : <div />}
                                </div>
                            </div>
                            <button onClick={() => setDarkMode(!darkMode)} style={{ position: 'fixed', bottom: '10px', right: '10px', padding: '10px', borderRadius: '50%', background: theme.navBtn, color: '#fff' }}>{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
