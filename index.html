<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Excel Randomizer Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        button { touch-action: manipulation; border: none; border-radius: 8px; cursor: pointer; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        @media (max-width: 600px) {
            .cell-display { font-size: 20px !important; padding: 15px !important; }
            .top-bar { flex-wrap: wrap; gap: 10px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const lightTheme = { bg: '#f8f9fa', card: '#fff', text: '#212529', border: '#ddd', primary: '#007bff' };
        const darkTheme = { bg: '#121212', card: '#1e1e1e', text: '#f8f9fa', border: '#333', primary: '#007bff' };

        function App() {
            const [workbook, setWorkbook] = useState(null);
            const [sheetNames, setSheetNames] = useState([]);
            const [selectedSheets, setSelectedSheets] = useState([]);
            const [currentRow, setCurrentRow] = useState(null);
            const [colIndex, setColIndex] = useState(0);
            const [rowIndex, setRowIndex] = useState(0);
            const [darkMode, setDarkMode] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [availableVoices, setAvailableVoices] = useState([]);
            const theme = darkMode ? darkTheme : lightTheme;

            // Load Voices & target Daniel (UK)
            useEffect(() => {
                const loadVoices = () => {
                    const voices = window.speechSynthesis.getVoices();
                    setAvailableVoices(voices);
                };
                loadVoices();
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }, []);

            const getColLetter = (index) => String.fromCharCode(65 + index);
            const hasContent = (val) => val !== undefined && val !== null && String(val).trim().length > 0;

            const getNeighborData = (rOffset, cOffset) => {
                if(!workbook || !currentRow) return null;
                const sheet = workbook.Sheets[currentRow.sheet];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                return data[rowIndex + rOffset]?.[colIndex + cOffset];
            };

            const updateActiveCell = (sheetName, rIdx, cIdx) => {
                window.speechSynthesis.cancel();
                setIsSpeaking(false);
                const sheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                setCurrentRow({ data: data[rIdx], sheet: sheetName });
                setColIndex(cIdx);
                setRowIndex(rIdx);
                setSearchResults([]); // Close search on selection
            };

            const pickRandom = () => {
                let pool = [];
                selectedSheets.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                    data.forEach((row, rIdx) => { if (hasContent(row[0])) pool.push({ sheet: name, rIdx }); });
                });
                if (pool.length === 0) return alert("No data found");
                const pick = pool[Math.floor(Math.random() * pool.length)];
                updateActiveCell(pick.sheet, pick.rIdx, 0);
            };

            const handleSearch = () => {
                if (!searchQuery.trim()) return;
                let results = [];
                selectedSheets.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                    data.forEach((row, rIdx) => {
                        row.forEach((cell, cIdx) => {
                            if (String(cell).toLowerCase().includes(searchQuery.toLowerCase())) {
                                results.push({ sheet: name, rIdx, cIdx, text: String(cell) });
                            }
                        });
                    });
                });
                setSearchResults(results);
            };

            const handleSpeak = () => {
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                    setIsSpeaking(false);
                } else {
                    const utterance = new SpeechSynthesisUtterance(currentRow.data[colIndex]);
                    // Logic to find Daniel UK
                    const daniel = availableVoices.find(v => v.name.includes("Daniel") || v.lang === "en-GB");
                    if (daniel) utterance.voice = daniel;
                    utterance.onend = () => setIsSpeaking(false);
                    window.speechSynthesis.speak(utterance);
                    setIsSpeaking(true);
                }
            };

            return (
                <div style={{ height: '100vh', width: '100vw', backgroundColor: theme.bg, color: theme.text, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                    
                    {!currentRow ? (
                        <div style={{ padding: '40px', background: theme.card, borderRadius: '15px', marginTop: '50px', width: '300px', textAlign: 'center', boxShadow: '0 10px 20px rgba(0,0,0,0.2)' }}>
                            <h2>Excel Randomizer</h2>
                            <input type="file" onChange={(e) => {
                                const reader = new FileReader();
                                reader.onload = (evt) => {
                                    const wb = XLSX.read(evt.target.result, { type: 'binary' });
                                    setWorkbook(wb); setSheetNames(wb.SheetNames);
                                };
                                reader.readAsBinaryString(e.target.files[0]);
                            }} style={{ width: '100%', marginBottom: '20px' }} />
                            
                            <div style={{ maxHeight: '150px', overflowY: 'auto', textAlign: 'left', border: `1px solid ${theme.border}`, padding: '10px', borderRadius: '8px' }}>
                                {sheetNames.map(name => (
                                    <label key={name} style={{ display: 'block', margin: '5px 0' }}>
                                        <input type="checkbox" checked={selectedSheets.includes(name)} onChange={() => setSelectedSheets(prev => prev.includes(name) ? prev.filter(s => s !== name) : [...prev, name])} /> {name}
                                    </label>
                                ))}
                            </div>
                            <button onClick={pickRandom} style={{ width: '100%', padding: '12px', background: theme.primary, color: '#fff', marginTop: '20px', fontWeight: 'bold' }}>START</button>
                        </div>
                    ) : (
                        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
                            {/* Top Bar */}
                            <div style={{ display: 'flex', padding: '10px', borderBottom: `1px solid ${theme.border}`, justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>{getColLetter(colIndex)}{rowIndex + 1}</span>
                                <div style={{ display: 'flex', gap: '5px' }}>
                                    <input placeholder="Search..." style={{ padding: '8px', borderRadius: '5px', border: `1px solid ${theme.border}` }} value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSearch()} />
                                    <button onClick={handleSearch} style={{ padding: '8px', background: theme.primary, color: '#white' }}>üîç</button>
                                </div>
                            </div>

                            {/* Main Display */}
                            <div style={{ flex: 1, display: 'flex', position: 'relative' }}>
                                {searchResults.length > 0 && (
                                    <div className="sidebar-scroll" style={{ width: '200px', background: theme.card, borderRight: `1px solid ${theme.border}`, overflowY: 'auto', fontSize: '12px', padding: '10px' }}>
                                        <b>Results ({searchResults.length})</b>
                                        {searchResults.map((r, i) => (
                                            <div key={i} onClick={() => updateActiveCell(r.sheet, r.rIdx, r.cIdx)} style={{ padding: '8px', borderBottom: `1px solid ${theme.border}`, cursor: 'pointer' }}>
                                                {r.sheet} {getColLetter(r.cIdx)}{r.rIdx+1}: {r.text.substring(0,20)}...
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="cell-display" style={{ flex: 1, padding: '30px', fontSize: '24px', overflowY: 'auto' }}>
                                    {currentRow.data[colIndex]}
                                </div>
                            </div>

                            {/* Controls */}
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', alignItems: 'center', background: theme.card, gap: '10px' }}>
                                <button onClick={handleSpeak} style={{ padding: '10px 20px', background: isSpeaking ? '#ffc107' : '#28a745', color: '#fff' }}>
                                    {isSpeaking ? 'STOP VOICE' : 'üîä READ (DANIEL UK)'}
                                </button>
                                
                                <button onClick={pickRandom} style={{ padding: '15px 40px', background: theme.primary, color: '#fff', fontWeight: 'bold', fontSize: '18px' }}>NEXT RANDOM</button>
                                
                                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '5px' }}>
                                    {hasContent(getNeighborData(-1, 0)) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex - 1, colIndex)} style={{ padding: '10px 20px', background: '#444', color: '#fff' }}>‚Üë</button>}
                                    <div style={{ display: 'flex', gap: '10px' }}>
                                        {hasContent(getNeighborData(0, -1)) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex, colIndex - 1)} style={{ padding: '10px 20px', background: '#444', color: '#fff' }}>‚Üê</button>}
                                        {hasContent(getNeighborData(1, 0)) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex + 1, colIndex)} style={{ padding: '10px 20px', background: '#444', color: '#fff' }}>‚Üì</button>}
                                        {hasContent(getNeighborData(0, 1)) && <button onClick={() => updateActiveCell(currentRow.sheet, rowIndex, colIndex + 1)} style={{ padding: '10px 20px', background: '#444', color: '#fff' }}>‚Üí</button>}
                                    </div>
                                </div>
                            </div>
                            <button onClick={() => setCurrentRow(null)} style={{ position: 'fixed', bottom: '20px', right: '20px', padding: '10px', borderRadius: '50%', background: '#666', color: '#fff' }}>‚öôÔ∏è</button>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
